# Библиотечный API

REST API для управления библиотекой: регистрация, авторизация, учет читателей, выдача/возврат книг, показ активных выдач.

**Технологии:** Python + FastAPI + SQLAlchemy + Alembic + SQLite + JWT

---

## Запуск проекта

```bash
git clone <репозиторий>
cd project
python -m venv venv
venv\Scripts\activate  # или `source venv/bin/activate` на Linux/macOS
pip install -r requirements.txt
alembic upgrade head
uvicorn Library.main:app --reload

```

Перейти на Swagger UI: (http://localhost:8000/docs)

---

## Аутентификация

Используется JWT-токен. Аутентификация выполняется по OAuth2PasswordBearer.

**Эндпоинты:**

* `POST /users/register` — регистрация библиотекаря (username/email + password)
* `POST /users/login` — получение токена

**Защищены:** все эндпоинты, связанные с управлением книгами, пользователями и выдачей.

**Библиотеки:**

* `python-jose` — для генерации и проверки JWT
* `passlib[bcrypt]` — хеширование паролей

**Реализация:**

* Пароль хешируется при регистрации, сохраняется в базе.
* При логине создается токен с `sub=username`, который передаётся в `Authorization: Bearer ...`
* Эндпоинты используют `Depends(get_current_user)`, чтобы удостовериться в авторизованности пользователя.

---

## Структура базы данных

**Reader** — читатели

* id, name, email (уникальный), hashed_password

**Book** — книги

* id, title, author, year, ISBN, num_of_books

**BorrowedBook** — журнал выдачи

* id, book_id, reader_id, borrow_date, return_date

> Отдельная таблица BorrowedBook позволяет вести историю выдач и возвратов

---

## Бизнес-логика: пункты 4.1, 4.2, 4.3

### 4.1 Выдача книги

* Книгу нельзя выдать, если `num_of_books == 0`
* Читателю нельзя выдать больше 3-х книг одновременно
* Сохраняется запись в BorrowedBook с NULL `return_date`

### 4.2 Возврат книги

* По `borrow_id` ищется запись о выдаче
* Если `return_date` уже есть — ошибка 400
* Кол-во книг увеличивается, добавляется `return_date`

### 4.3 Активные выдачи

* Список всех записей с `return_date is NULL`
* Выводится информация о книге и дате выдачи

**Сложности:** ограничения на выдачу книг не сработали сразу — решено через фильтр `return_date.is_(None).count()`

---

## Тестирование

Использовался `pytest` и `TestClient` из FastAPI.

### Покрытые кейсы:

* Попытка взять книгу, которой нет в наличии → 400
*  Попытка взять четвёртую книгу (если уже 3 выданы) → 400
*  Проверка защищенного эндпоинта (с токеном и без)

База данных очищалась перед тестами для чистоты состояния.

---

## Дополнительная идея

Фильтрация и поиск книг по автору, году или ISBN:

```url
/books/?author=Толстой&year=1869
```

Можно реализовать через `Depends` и SQLAlchemy фильтры.

---

## Автор

Разработано в рамках тестового задания для стажировки.
Не мало делалось впервые: от Alembic до тестов и тд.
Писал проект с упором на логику, удобство и читаемость.
Мне кажется что получилось хорошо:).